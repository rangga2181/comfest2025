<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEA Catering - Welcome</title>
    <style>
        :root { --primary-color: #2E8B57; --secondary-color: #256d47; --light-gray: #f8f9fa; --dark-gray: #343a40; --text-color: #333; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; padding-top: 70px; background-color: var(--light-gray); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 1100px; margin: 20px auto; padding: 0 20px; }
        .page-section { display: none; padding: 30px; margin-bottom: 20px; background: #ffffff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); animation: fadeIn 0.5s ease-in-out; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h1 { font-size: 3em; color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); }
        h2 { font-size: 2em; color: var(--primary-color); border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 20px; }
        h3 { color: var(--secondary-color); }
        .btn { display: inline-block; background-color: var(--primary-color); color: white; padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; text-decoration: none; transition: background-color 0.3s; font-size: 1em; width: 100%; box-sizing: border-box; text-align: center; }
        .btn:hover:not(:disabled) { background-color: var(--secondary-color); }
        .btn:disabled { background-color: #9E9E9E; cursor: not-allowed; }
        .navbar { background-color: #ffffff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; height: 70px; }
        .nav-brand { font-size: 1.5em; font-weight: bold; color: var(--primary-color); text-decoration: none; cursor: pointer; }
        .nav-links { list-style: none; margin: 0; padding: 0; display: flex; align-items: center; }
        .nav-links li { margin-left: 5px; }
        .nav-links a, .nav-links .nav-text { display: block; padding: 10px 15px; text-decoration: none; color: var(--text-color); font-weight: 500; border-radius: 5px; transition: background-color 0.2s, color 0.2s; cursor: pointer; }
        .nav-links a:hover { background-color: #f0f0f0; }
        .nav-links a.active { background-color: var(--primary-color); color: white; }
        .form-group { display: flex; flex-direction: column; margin-bottom: 15px; }
        .form-group label { margin-bottom: 8px; font-weight: bold; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .form-group small { font-size: 0.8em; color: #666; margin-top: 5px; }
        .status-message { padding: 15px; margin-top: 20px; border-radius: 5px; display: none; text-align: center; }
        .status-message.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-message.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .auth-container { max-width: 450px; margin: 20px auto; }
        .form-toggle { text-align: center; margin-top: 20px; }
        .form-toggle span { color: var(--primary-color); cursor: pointer; text-decoration: underline; }
        .hero { background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1504674900247-0877df9cc836?q=80&w=2070') no-repeat center center; background-size: cover; text-align: center; padding: 80px 20px; color: white; border-radius: 8px; }
        .meal-plans-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .meal-card { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center; }
        .meal-card img { width: 100%; height: 180px; object-fit: cover; }
        .meal-card-content { padding: 20px; }
        .testimonial-grid { display: grid; grid-template-columns: 1fr; gap: 40px; }
        @media (min-width: 992px) { .testimonial-grid { grid-template-columns: 2fr 1fr; } }
        .testimonial-slider { position: relative; min-height: 180px; background: #fdfdfd; padding: 30px; border-radius: 8px; border: 1px solid #eee; }
        .testimonial-slide { display: none; text-align: center; }
        .testimonial-slide.active { display: block; animation: fadeIn 0.5s; }
        .testimonial-slide blockquote { font-style: italic; font-size: 1.1em; margin: 0 0 15px 0; border: none; padding: 0; }
        .testimonial-slide .author { font-weight: bold; color: var(--secondary-color); }
        .testimonial-slide .stars { color: #fdd835; margin-top: 10px; font-size: 1.2em; }
        .slider-nav { position: absolute; top: 50%; width: calc(100% - 20px); left: 10px; display: flex; justify-content: space-between; transform: translateY(-50%); z-index: 10; }
        .slider-nav button { background: rgba(0,0,0,0.2); color: white; border: none; padding: 8px 12px; font-size: 16px; cursor: pointer; border-radius: 50%; width: 40px; height: 40px; line-height: 1; }
        .rating-stars { display: inline-flex; flex-direction: row-reverse; justify-content: flex-end; }
        .rating-stars input { display: none; }
        .rating-stars label { color: #ccc; cursor: pointer; font-size: 2.5em; transition: color 0.2s; padding: 0 2px; }
        .rating-stars input:checked ~ label, .rating-stars label:hover, .rating-stars label:hover ~ label { color: #fdd835; }
    </style>
</head>
<body>
    <nav class="navbar"><a href="index.html" class="nav-brand">SEA Catering</a><div id="nav-dynamic-content"></div></nav>
    <div class="container">
        <div id="auth-section">
            <div id="login-view" class="auth-container page-section"></div>
            <div id="register-view" class="auth-container page-section"></div>
        </div>
        <div id="app-section">
            <section id="home-view" class="app-view page-section"></section>
            <section id="menu-view" class="app-view page-section"></section>
            <section id="testimonial-view" class="app-view page-section"></section>
            <section id="admin-panel" class="app-view page-section"></section>
        </div>
    </div>
    
    <script>
        // Logika JavaScript untuk Halaman Utama (index.html)
        const API_BASE_URL = 'http://127.0.0.1:3000/api';
        let csrfToken = null, isLoading = true, testimonialsData = [], currentTestimonialIndex = 0;
        
        const ui = { nav: document.getElementById('nav-dynamic-content'), authSection: document.getElementById('auth-section'), appSection: document.getElementById('app-section'), loginView: document.getElementById('login-view'), registerView: document.getElementById('register-view'), adminPanel: document.getElementById('admin-panel'), loginStatus: null, registerStatus: null, testimonialStatus: null, testimonialSlider: null, appViews: document.querySelectorAll('.app-view') };

        function setupUIReferences() {
            ui.allButtons = document.querySelectorAll('button'); ui.loginForm = document.getElementById('login-form'); ui.registerForm = document.getElementById('register-form'); ui.testimonialForm = document.getElementById('testimonial-form');
            ui.loginStatus = document.getElementById('login-status'); ui.registerStatus = document.getElementById('register-status'); ui.testimonialStatus = document.getElementById('testimonial-status');
            ui.testimonialSlider = document.getElementById('testimonial-slider');
        }

        function populateStaticHTML() {
            ui.loginView.innerHTML = `<form id="login-form"><h2>Login</h2><div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" name="email" required></div><div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" name="password" required></div><button type="submit" class="btn">Login</button><div id="login-status" class="status-message"></div></form><div class="form-toggle">Belum punya akun? <span onclick="toggleAuthView(false)">Daftar di sini</span></div>`;
            ui.registerView.innerHTML = `<form id="register-form"><h2>Registrasi</h2><div class="form-group"><label for="reg-name">Nama Lengkap</label><input type="text" id="reg-name" name="name" required></div><div class="form-group"><label for="reg-email">Email</label><input type="email" id="reg-email" name="email" required></div><div class="form-group"><label for="reg-password">Password</label><input type="password" id="reg-password" name="password" required><small>Minimal 8 karakter, dengan huruf besar, kecil, angka, dan simbol.</small></div><button type="submit" class="btn">Register</button><div id="register-status" class="status-message"></div></form><div class="form-toggle">Sudah punya akun? <span onclick="toggleAuthView(true)">Login di sini</span></div>`;
            document.querySelector('#home-view').innerHTML = `<div class="hero"><h1>Healthy Meals, Anytime, Anywhere</h1><p>Selamat datang di SEA Catering! Kami menyediakan katering sehat dengan menu yang bisa disesuaikan dan diantar ke seluruh Indonesia.</p></div><h2>Layanan Utama Kami</h2><ul><li><strong>Meal Customization:</strong> Sesuaikan setiap makanan dengan kebutuhan kalori dan preferensi diet Anda.</li><li><strong>Pengiriman Luas:</strong> Kami menjangkau semua kota besar di Indonesia.</li><li><strong>Informasi Nutrisi Lengkap:</strong> Setiap hidangan dilengkapi dengan detail gizi.</li></ul>`;
            document.querySelector('#menu-view').innerHTML = `<h2>Pilihan Paket Menu Kami</h2><p>Setiap paket dirancang oleh ahli gizi untuk memenuhi tujuan kesehatan Anda. Langganan di tab "Subscription"!</p><div class="meal-plans-grid"><div class="meal-card"><img src="https://images.unsplash.com/photo-1512621776951-a57141f2eefd?q=80&w=2070" alt="Diet Plan"><div class="meal-card-content"><h3>Diet Plan</h3><p><strong>Rp 30.000/meal</strong></p></div></div><div class="meal-card"><img src="https://images.unsplash.com/photo-1482049016688-2d3e1b311543?q=80&w=1910" alt="Protein Plan"><div class="meal-card-content"><h3>Protein Plan</h3><p><strong>Rp 40.000/meal</strong></p></div></div><div class="meal-card"><img src="https://images.unsplash.com/photo-1498837167922-ddd27525d352?q=80&w=2070" alt="Royal Plan"><div class="meal-card-content"><h3>Royal Plan</h3><p><strong>Rp 60.000/meal</strong></p></div></div></div>`;
            document.querySelector('#testimonial-view').innerHTML = `<h2>Testimoni Pelanggan</h2><div class="testimonial-grid"><div class="testimonial-slider-wrapper"><h3>Kata Mereka Tentang Kami</h3><div id="testimonial-slider" class="testimonial-slider"><div class="slider-nav"><button id="prev-slide">&lt;</button><button id="next-slide">&gt;</button></div></div></div><div><h3>Bagikan Pengalaman Anda</h3><form id="testimonial-form"><div class="form-group"><label>Rating Anda</label><div class="rating-stars"><input type="radio" id="5-stars" name="rating" value="5" required><label for="5-stars">★</label><input type="radio" id="4-stars" name="rating" value="4"><label for="4-stars">★</label><input type="radio" id="3-stars" name="rating" value="3"><label for="3-stars">★</label><input type="radio" id="2-stars" name="rating" value="2"><label for="2-stars">★</label><input type="radio" id="1-star" name="rating" value="1"><label for="1-star">★</label></div></div><div class="form-group"><label for="review-message">Ulasan Anda</label><textarea id="review-message" name="review_message" rows="4" required placeholder="Ceritakan pengalaman Anda..."></textarea></div><button type="submit" class="btn">Kirim Testimoni</button><div id="testimonial-status" class="status-message"></div></form></div></div>`;
            document.querySelector('#admin-panel').innerHTML = `<h2>Admin Panel</h2><p>Area ini hanya bisa diakses oleh admin untuk mengelola langganan dan pengguna.</p>`;
            setupUIReferences();
        }

        function setLoadingState(loading) { if(ui.allButtons) ui.allButtons.forEach(button => button.disabled = loading); }
        function renderUI(authState) {
            if (authState.loggedIn) {
                const user = authState.user;
                ui.nav.innerHTML = `<ul class="nav-links"><li><span class="nav-text">Welcome, ${escapeHTML(user.name)}!</span></li><li><a href="#home-view" class="nav-app-link">Home</a></li><li><a href="#menu-view" class="nav-app-link">Menu</a></li><li><a href="subscription.html">Subscription</a></li><li><a href="#testimonial-view" class="nav-app-link">Testimonials</a></li>${user.role === 'admin' ? `<li><a href="#admin-panel" class="nav-app-link">Admin</a></li>` : ''}<li><a href="#" id="logout-btn">Logout</a></li></ul>`;
                ui.authSection.style.display = 'none'; ui.appSection.style.display = 'block';
                if (user.role === 'admin') ui.adminPanel.style.display = 'block';
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
                document.querySelectorAll('.nav-app-link').forEach(link => link.addEventListener('click', handleAppNavigation));
                showAppView(window.location.hash ? window.location.hash.substring(1) : 'home-view');
            } else {
                ui.nav.innerHTML = `<ul class="nav-links"><li><a href="#login-view" onclick="toggleAuthView(true)">Login/Register</a></li></ul>`;
                ui.authSection.style.display = 'block'; ui.appSection.style.display = 'none';
                toggleAuthView(true);
            }
        }
        function toggleAuthView(showLogin) { ui.loginView.style.display = showLogin ? 'block' : 'none'; ui.registerView.style.display = showLogin ? 'none' : 'block'; }
        function escapeHTML(str) { const p = document.createElement('p'); p.textContent = str; return p.innerHTML; }
        function showStatusMessage(element, status, message) { element.className = `status-message ${status}`; element.textContent = message; element.style.display = 'block'; setTimeout(() => { element.style.display = 'none'; }, 5000); }
        function showAppView(targetId) { ui.appViews.forEach(view => view.classList.toggle('active', view.id === targetId)); document.querySelectorAll('.nav-app-link').forEach(link => link.classList.toggle('active', link.hash === `#${targetId}`)); window.location.hash = targetId; }
        function handleAppNavigation(e) { e.preventDefault(); const targetId = e.currentTarget.hash.substring(1); showAppView(targetId); }
        function populateTestimonials(testimonials) {
            const slider = ui.testimonialSlider;
            const nav = slider.querySelector('.slider-nav');
            slider.innerHTML = ''; slider.appendChild(nav);
            if (testimonials.length === 0) { slider.insertAdjacentHTML('afterbegin', `<div class="testimonial-slide active"><p>Belum ada testimoni.</p></div>`);
            } else { testimonials.forEach(t => { const stars = '★'.repeat(t.rating) + '☆'.repeat(5 - t.rating); slider.insertAdjacentHTML('afterbegin', `<div class="testimonial-slide"><blockquote>“${escapeHTML(t.review_message)}”</blockquote><div class="stars">${stars}</div><p class="author">- ${escapeHTML(t.customer_name)}</p></div>`); }); }
            showTestimonialSlide(0);
        }
        function showTestimonialSlide(index) { const slides = ui.testimonialSlider.querySelectorAll('.testimonial-slide'); if (!slides || slides.length === 0) return; if (index >= slides.length) index = 0; if (index < 0) index = slides.length - 1; slides.forEach(slide => slide.classList.remove('active')); slides[index].classList.add('active'); currentTestimonialIndex = index; }
        function changeTestimonialSlide(direction) { showTestimonialSlide(currentTestimonialIndex + direction); }

        async function initializeApp() {
            setLoadingState(true);
            try {
                const csrfRes = await fetch(`${API_BASE_URL}/csrf-token`, { credentials: 'include' });
                if (!csrfRes.ok) throw new Error(`Gagal CSRF`);
                csrfToken = (await csrfRes.json()).csrfToken;
                
                const [authRes, testimonialsRes] = await Promise.all([ fetch(`${API_BASE_URL}/auth/check`, { credentials: 'include' }), fetch(`${API_BASE_URL}/testimonials`, { credentials: 'include' }) ]);
                const authData = await authRes.json();
                const testimonialsResult = await testimonialsRes.json();
                
                if (testimonialsResult.status === 'success') { testimonialsData = testimonialsResult.data; populateTestimonials(testimonialsData); }
                if (authData.status === 'success') renderUI({ loggedIn: true, user: authData.user }); else renderUI({ loggedIn: false });
            } catch (err) { console.error("Gagal inisialisasi:", err); renderUI({ loggedIn: false }); showStatusMessage(ui.loginStatus, 'error', 'Gagal terhubung ke server.'); } 
            finally { setLoadingState(false); }
        }
        
        async function handleFormSubmit(url, form, statusElement, isAuthAction = false) {
            setLoadingState(true);
            const formData = new FormData(form);
            try {
                const data = Object.fromEntries(formData.entries());
                const response = await fetch(url, { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json', 'csrf-token': csrfToken }, body: JSON.stringify(data) });
                const result = await response.json();
                showStatusMessage(statusElement, result.status, result.message);
                if (result.status === 'success') {
                    if (isAuthAction) { location.reload(); } 
                    else if (form.id === 'testimonial-form') { testimonialsData.unshift(result.data); populateTestimonials(testimonialsData); form.reset(); }
                }
            } catch (err) { showStatusMessage(statusElement, 'error', 'Terjadi kesalahan jaringan.'); } 
            finally { setLoadingState(false); }
        }

        async function handleLogout(e) { e.preventDefault(); setLoadingState(true); await fetch(`${API_BASE_URL}/auth/logout`, { method: 'POST', credentials: 'include', headers: { 'csrf-token': csrfToken } }); location.reload(); }

        document.addEventListener('DOMContentLoaded', () => {
            populateStaticHTML();
            initializeApp();
            ui.registerForm.addEventListener('submit', (e) => { e.preventDefault(); handleFormSubmit(`${API_BASE_URL}/auth/register`, e.target, ui.registerStatus, true); });
            ui.loginForm.addEventListener('submit', (e) => { e.preventDefault(); handleFormSubmit(`${API_BASE_URL}/auth/login`, e.target, ui.loginStatus, true); });
            ui.testimonialForm.addEventListener('submit', (e) => { e.preventDefault(); handleFormSubmit(`${API_BASE_URL}/testimonials`, e.target, ui.testimonialStatus); });
            document.getElementById('prev-slide').addEventListener('click', () => changeTestimonialSlide(-1));
            document.getElementById('next-slide').addEventListener('click', () => changeTestimonialSlide(1));
        });
    </script>
</body>
</html>